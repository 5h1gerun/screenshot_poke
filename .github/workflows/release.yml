name: Notify Discord on Release

on:
  release:
    types: [published, prereleased, released, edited]
  workflow_dispatch:

# 同一リリースで同時多発を防止（保険）
concurrency:
  group: release-${{ github.event.release.id }}
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      # --- 通知ゲート（ここで「送る/送らない」を判定） ---
      - name: Decide whether to notify
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          E="$GITHUB_EVENT_PATH"
          ACTION=$(jq -r '.action' "$E")
          SKIP=false

          if [ "$ACTION" = "edited" ]; then
            # name/body が変わっていなければ送らない
            if ! jq -e '.changes.name // empty | length > 0' "$E" >/dev/null && \
               ! jq -e '.changes.body // empty | length > 0' "$E" >/dev/null; then
              echo "Reason: edited but neither name nor body changed" >&2
              SKIP=true
            fi

            # 公開直後すぎる編集（90秒以内）は送らない（必要に応じて閾値を変更）
            PUB=$(jq -r '.release.published_at // .release.created_at // empty' "$E")
            UPD=$(jq -r '.release.updated_at // empty' "$E")
            if [ -n "$PUB" ] && [ -n "$UPD" ]; then
              # Ubuntuランナーは GNU date が使える
              DIFF=$(( $(date -d "$UPD" +%s) - $(date -d "$PUB" +%s) ))
              if [ "$DIFF" -lt 90 ]; then
                echo "Reason: early edited within 90s after publish ($DIFF s)" >&2
                SKIP=true
              fi
            fi
          fi

          echo "skip=$SKIP" >> "$GITHUB_OUTPUT"

      # --- ここから先は gate でスキップされない時だけ実行 ---
      - name: Build fancy embed payload
        if: steps.gate.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          E="$GITHUB_EVENT_PATH"

          ACTION=$(jq -r '.action' "$E")
          REPO="$GITHUB_REPOSITORY"
          NAME=$(jq -r '.release.name // empty' "$E")
          TAG=$(jq -r '.release.tag_name' "$E")
          URL=$(jq -r '.release.html_url' "$E")
          BODY=$(jq -r '.release.body // ""' "$E")
          AVATAR=$(jq -r '.release.author.avatar_url // ""' "$E")
          PUBLISHED_AT=$(jq -r '.release.published_at // .release.created_at // ""' "$E")

          SNIP=$(printf "%s" "$BODY" | tr -d '\r' | tr '\n' ' ' | sed 's/  \+/ /g' | cut -c1-380)
          [ -n "$BODY" ] && [ "${#BODY}" -gt "${#SNIP}" ] && SNIP="${SNIP}…"

          ASSETS_TXT=$(jq -r '[.release.assets[]? | {name, url: .browser_download_url}] | .[:3] | if length==0 then "" else ( map("[" + .name + "](" + .url + ")") | join("\n") ) end' "$E")
          FIRST_ASSET_URL=$(jq -r '.release.assets[0]?.browser_download_url // ""' "$E")

          case "$ACTION" in
            published)   COLOR=3066993 ;;   # green
            edited)      COLOR=15844367 ;;  # orange
            prereleased) COLOR=10181046 ;;  # purple
            released)    COLOR=3447003 ;;   # blue (昇格)
            *)           COLOR=5814783 ;;   # gray
          esac

          PREFIX="ℹ️ リリース"
          [ "$ACTION" = "published" ]   && PREFIX="🚀 公開"
          [ "$ACTION" = "edited" ]      && PREFIX="✏️ 更新"
          [ "$ACTION" = "prereleased" ] && PREFIX="🧪 プレリリース"
          [ "$ACTION" = "released" ]    && PREFIX="✅ 正式リリース"
          TITLE="$PREFIX: ${NAME:-$TAG}"

          EMBED=$(jq -nc \
            --arg title "$TITLE" \
            --arg url "$URL" \
            --arg desc "${SNIP:-$REPO のリリースです}" \
            --arg repo "$REPO" \
            --arg tag "$TAG" \
            --arg footer "action: $ACTION" \
            --arg avatar "$AVATAR" \
            --arg assets "$ASSETS_TXT" \
            --arg ts "$PUBLISHED_AT" \
            --argjson color "$COLOR" \
            '{
              username: "GitHub • Releases",
              avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              embeds: [{
                title: $title, url: $url, description: $desc, color: $color,
                author: { name: $repo, icon_url: "https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" },
                thumbnail: (if $avatar != "" then {url: $avatar} else null end),
                timestamp: (if $ts != "" then $ts else (now|todate) end),
                fields: (
                  [
                    {name:"Repository", value:$repo, inline:true},
                    {name:"Tag",        value:$tag,  inline:true}
                  ] + (if $assets != "" then [{name:"Assets (top 3)", value:$assets, inline:false}] else [] end)
                ),
                footer: { text: $footer }
              }]
            }')

          if [ -n "$FIRST_ASSET_URL" ]; then
            EMBED=$(echo "$EMBED" | jq --arg rel "$URL" --arg dl "$FIRST_ASSET_URL" \
              '. + {components: [{type:1, components:[
                  {type:2, style:5, label:"Open Release", url:$rel},
                  {type:2, style:5, label:"Download (1st asset)", url:$dl}
              ]}]}')
          else
            EMBED=$(echo "$EMBED" | jq --arg rel "$URL" \
              '. + {components: [{type:1, components:[
                  {type:2, style:5, label:"Open Release", url:$rel}
              ]}]}')
          fi

          printf '%s\n' "$EMBED" > payload.json

      - name: Send to Discord
        if: steps.gate.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          curl -sS -H "Content-Type: application/json; charset=utf-8" \
               -X POST --data-binary @payload.json \
               "$WEBHOOK"