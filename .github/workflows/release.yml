name: Notify Discord on Release

on:
  release:
    types: [published, edited, prereleased]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - name: Build fancy embed payload
        id: build
        run: |
          set -euo pipefail

          E="$GITHUB_EVENT_PATH"

          ACTION=$(jq -r '.action' "$E")
          REPO="$GITHUB_REPOSITORY"
          NAME=$(jq -r '.release.name // empty' "$E")
          TAG=$(jq -r '.release.tag_name' "$E")
          URL=$(jq -r '.release.html_url' "$E")
          BODY=$(jq -r '.release.body // ""' "$E")
          AVATAR=$(jq -r '.release.author.avatar_url // ""' "$E")
          PRERELEASE=$(jq -r '.release.prerelease' "$E")
          PUBLISHED_AT=$(jq -r '.release.published_at // .release.created_at // ""' "$E")

          # æœ¬æ–‡ã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼ˆæ”¹è¡Œâ†’ã‚¹ãƒšãƒ¼ã‚¹ã€æœ€å¤§380æ–‡å­—ï¼‰
          SNIP=$(printf "%s" "$BODY" | tr -d '\r' | tr '\n' ' ' | sed 's/  \+/ /g' | cut -c1-380)
          [ -n "$BODY" ] && [ "${#BODY}" -gt "${#SNIP}" ] && SNIP="${SNIP}â€¦"

          # ã‚¢ã‚»ãƒƒãƒˆï¼ˆæœ€åˆã®3ä»¶ï¼‰
          ASSETS_TXT=$(jq -r '[.release.assets[]? | {name, url: .browser_download_url}] | .[:3] | if length==0 then "" else ( map("[" + .name + "](" + .url + ")") | join("\n") ) end' "$E")
          FIRST_ASSET_URL=$(jq -r '.release.assets[0]?.browser_download_url // ""' "$E")

          # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã®è‰²
          case "$ACTION" in
            published)   COLOR=3066993 ;;   # ç·‘
            edited)      COLOR=15844367 ;;  # é»„
            prereleased) COLOR=10181046 ;;  # ç´«
            *)           COLOR=5814783 ;;
          esac

          # ã‚¿ã‚¤ãƒˆãƒ«
          PREFIX="â„¹ï¸ ãƒªãƒªãƒ¼ã‚¹"
          [ "$ACTION" = "published" ]   && PREFIX="ðŸš€ å…¬é–‹"
          [ "$ACTION" = "edited" ]      && PREFIX="âœï¸ æ›´æ–°"
          [ "$ACTION" = "prereleased" ] && PREFIX="ðŸ§ª ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹"
          TITLE="$PREFIX: ${NAME:-$TAG}"

          # Embedæœ¬ä½“
          EMBED=$(jq -nc \
            --arg title "$TITLE" \
            --arg url "$URL" \
            --arg desc "${SNIP:-$REPO ã®ãƒªãƒªãƒ¼ã‚¹ã§ã™}" \
            --arg repo "$REPO" \
            --arg tag "$TAG" \
            --arg footer "action: $ACTION" \
            --arg avatar "$AVATAR" \
            --arg assets "$ASSETS_TXT" \
            --arg ts "$PUBLISHED_AT" \
            --argjson color "$COLOR" \
            '{
              username: "GitHub â€¢ Releases",
              avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              embeds: [{
                title: $title, url: $url, description: $desc, color: $color,
                author: { name: $repo, icon_url: "https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" },
                thumbnail: (if $avatar != "" then {url: $avatar} else null end),
                timestamp: (if $ts != "" then $ts else (now|todate) end),
                fields: (
                  [
                    {name:"Repository", value:$repo, inline:true},
                    {name:"Tag",        value:$tag,  inline:true}
                  ] + (if $assets != "" then [{name:"Assets (top 3)", value:$assets, inline:false}] else [] end)
                ),
                footer: { text: $footer }
              }]
            }')

          # ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ï¼ˆRelease, å…ˆé ­ã‚¢ã‚»ãƒƒãƒˆï¼‰ã‚’è¿½åŠ 
          if [ -n "$FIRST_ASSET_URL" ]; then
            EMBED=$(echo "$EMBED" | jq --arg rel "$URL" --arg dl "$FIRST_ASSET_URL" \
              '. + {components: [{type:1, components:[
                  {type:2, style:5, label:"Open Release", url:$rel},
                  {type:2, style:5, label:"Download (1st asset)", url:$dl}
              ]}]}')
          else
            EMBED=$(echo "$EMBED" | jq --arg rel "$URL" \
              '. + {components: [{type:1, components:[
                  {type:2, style:5, label:"Open Release", url:$rel}
              ]}]}')
          fi

          echo "body=$(printf '%s' "$EMBED")" >> "$GITHUB_OUTPUT"

      - name: Send to Discord
        run: |
          curl -sS -H "Content-Type: application/json; charset=utf-8" \
               -X POST \
               -d '${{ steps.build.outputs.body }}' \
               "$WEBHOOK"
