name: Notify Discord on Release

on:
  release:
    # ã™ã¹ã¦æ‹¾ã£ã¦ãŠãï¼ˆå¿…è¦ãªã‚‰å¾Œã§ifã§çµã‚‹ï¼‰
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      ACTION: ${{ github.event.action }}                             # published / edited / ...
      IS_PRERELEASE: ${{ github.event.release.prerelease }}
      IS_DRAFT: ${{ github.event.release.draft }}
      RELEASE_NAME: ${{ github.event.release.name }}
      TAG_NAME: ${{ github.event.release.tag_name }}
      RELEASE_URL: ${{ github.event.release.html_url }}
      REPO: ${{ github.repository }}
    steps:
      - name: Build Discord embed payload
        id: build
        run: |
          set -euo pipefail

          # è¡¨ç¤ºç”¨ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’ action ã§åˆ‡æ›¿
          case "$ACTION" in
            published)    PREFIX="ğŸš€ å…¬é–‹";;
            edited)       PREFIX="âœï¸ æ›´æ–°";;
            created)      PREFIX="ğŸ“ ä¸‹æ›¸ãä½œæˆ/å³æ™‚å…¬é–‹";;
            deleted)      PREFIX="ğŸ—‘ï¸ å‰Šé™¤";;
            unpublished)  PREFIX="ğŸ“¥ éå…¬é–‹ã«æˆ»ã™";;
            prereleased)  PREFIX="ğŸ§ª ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹å…¬é–‹";;
            *)            PREFIX="â„¹ï¸ ãƒªãƒªãƒ¼ã‚¹";;
          esac

          # ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆåå‰ãŒç„¡ã‘ã‚Œã°ã‚¿ã‚°ã‚’ä½¿ã†ï¼‰
          TITLE="${PREFIX}: ${RELEASE_NAME:-$TAG_NAME}"

          # èª¬æ˜æ–‡ï¼ˆãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹/ãƒ‰ãƒ©ãƒ•ãƒˆã®æ³¨è¨˜ï¼‰
          NOTE=""
          [ "${IS_PRERELEASE}" = "true" ] && NOTE="${NOTE}(ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹)"
          [ "${IS_DRAFT}" = "true" ] && NOTE="${NOTE}(ãƒ‰ãƒ©ãƒ•ãƒˆ)"
          DESC="${REPO} ã®ãƒªãƒªãƒ¼ã‚¹ãŒ ${ACTION} ã•ã‚Œã¾ã—ãŸã€‚${NOTE}"

          # Embed JSON ã‚’ jq ã§ç”Ÿæˆï¼ˆUTF-8ï¼‰
          BODY=$(jq -nc \
            --arg title "$TITLE" \
            --arg url "${RELEASE_URL:-https://github.com/$REPO/releases}" \
            --arg desc "$DESC" \
            --arg repo "$REPO" \
            --arg tag "$TAG_NAME" \
            --arg action "$ACTION" \
            --argjson color 5814783 \
            '{embeds: [{
                title: $title,
                url: $url,
                description: $desc,
                color: $color,
                footer: { text: ("action: " + $action) },
                fields: [
                  { name: "Repository", value: $repo, inline: true },
                  { name: "Tag",        value: $tag,  inline: true }
                ]
            }]}' )

          echo "body=$BODY" >> "$GITHUB_OUTPUT"

      - name: Send to Discord
        # ä¾‹: ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã‚’é€šçŸ¥ã—ãŸããªã„å ´åˆã¯ if ã§é™¤å¤–ã§ãã‚‹
        # if: env.IS_PRERELEASE != 'true'
        run: |
          set -euo pipefail
          curl -sS -H "Content-Type: application/json; charset=utf-8" \
               -X POST \
               -d '${{ steps.build.outputs.body }}' \
               "${WEBHOOK}"
