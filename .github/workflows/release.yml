name: Notify Discord on Release

on:
  release:
    types: [published, edited]
  workflow_dispatch: {}   # â† æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯ï¼ˆActionsç”»é¢ã§ Run workflow ãŒå‡ºã¾ã™ï¼‰

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build Discord embed payload
        id: build
        run: |
          set -euo pipefail
          # æ‰‹å‹•å®Ÿè¡Œæ™‚ï¼ˆã‚¿ã‚°ãŒç„¡ã„å ´åˆï¼‰ã«å‚™ãˆãŸURL/ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          REF_NAME="${GITHUB_REF_NAME:-manual}"
          RELEASE_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/tag/$REF_NAME"
          if [ "$REF_NAME" = "manual" ]; then
            RELEASE_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases"
          fi

          BODY=$(jq -nc \
            --arg title "ðŸ“¢ æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹: $REF_NAME" \
            --arg url "$RELEASE_URL" \
            --arg desc "$GITHUB_REPOSITORY ã®ãƒªãƒªãƒ¼ã‚¹ãŒå…¬é–‹ãƒ»æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚" \
            --argjson color 5814783 \
            '{embeds: [{title: $title, url: $url, description: $desc, color: $color}]}' )
          echo "body=$BODY" >> "$GITHUB_OUTPUT"

      - name: Send to Discord
        run: |
          set -euo pipefail
          echo "Payload: ${{ steps.build.outputs.body }}"
          curl -v -H "Content-Type: application/json; charset=utf-8" \
               -X POST \
               -d '${{ steps.build.outputs.body }}' \
               '${{ secrets.DISCORD_WEBHOOK }}'
